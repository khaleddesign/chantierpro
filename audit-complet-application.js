#!/usr/bin/env node

/**
 * AUDIT COMPLET - APPLICATION CHANTIERPRO
 * 
 * Script d'audit automatis√© pour √©valuer:
 * - S√©curit√©
 * - Performance 
 * - Qualit√© du code
 * - Fonctionnalit√©s
 * - Base de donn√©es
 * - Configuration
 */

const { PrismaClient } = require('@prisma/client');
const fs = require('fs');
const path = require('path');

const prisma = new PrismaClient();

class ChantierProAudit {
  constructor() {
    this.results = {
      security: { score: 0, issues: [], recommendations: [] },
      performance: { score: 0, metrics: [], issues: [], recommendations: [] },
      functionality: { score: 0, modules: [], issues: [], recommendations: [] },
      database: { score: 0, stats: {}, issues: [], recommendations: [] },
      codeQuality: { score: 0, metrics: {}, issues: [], recommendations: [] },
      configuration: { score: 0, config: {}, issues: [], recommendations: [] },
      overallScore: 0
    };
  }

  async runFullAudit() {
    console.log('üîç AUDIT COMPLET - CHANTIERPRO');
    console.log('=' .repeat(60));
    console.log(`üìÖ Date: ${new Date().toLocaleString('fr-FR')}`);
    console.log(`üèóÔ∏è  Version: Application ChantierPro CRM BTP`);
    console.log('=' .repeat(60));

    try {
      await this.auditSecurity();
      await this.auditDatabase();
      await this.auditFunctionality();
      await this.auditPerformance();
      await this.auditCodeQuality();
      await this.auditConfiguration();
      
      this.calculateOverallScore();
      await this.generateReport();
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'audit:', error);
      throw error;
    }
  }

  async auditSecurity() {
    console.log('\nüîí AUDIT S√âCURIT√â...');
    
    let securityScore = 0;
    const issues = [];
    const recommendations = [];

    // 1. V√©rification des variables d'environnement sensibles
    if (process.env.NEXTAUTH_SECRET && process.env.NEXTAUTH_SECRET !== 'changez-cette-cle-secrete-en-production') {
      securityScore += 15;
    } else {
      issues.push('NEXTAUTH_SECRET faible ou par d√©faut');
      recommendations.push('G√©n√©rer une cl√© secr√®te robuste pour NEXTAUTH_SECRET');
    }

    // 2. V√©rification de l'URL de production
    if (process.env.NEXTAUTH_URL) {
      securityScore += 10;
      if (process.env.NEXTAUTH_URL.startsWith('https://')) {
        securityScore += 10;
      } else {
        issues.push('NEXTAUTH_URL non s√©curis√©e (non HTTPS)');
        recommendations.push('Utiliser HTTPS en production');
      }
    }

    // 3. V√©rification de la base de donn√©es
    if (process.env.DATABASE_URL) {
      if (process.env.DATABASE_URL.includes('sqlite')) {
        issues.push('Base SQLite en production non recommand√©e');
        recommendations.push('Migrer vers PostgreSQL/MySQL en production');
      } else {
        securityScore += 15;
      }
    }

    // 4. V√©rification des utilisateurs par d√©faut
    try {
      const adminUsers = await prisma.user.findMany({
        where: { role: 'ADMIN' },
        select: { email: true, password: true }
      });
      
      const defaultUsers = adminUsers.filter(u => 
        u.email.includes('@chantierpro.fr') || 
        u.email.includes('admin@') ||
        u.email.includes('test@')
      );

      if (defaultUsers.length > 0) {
        issues.push(`${defaultUsers.length} utilisateurs par d√©faut d√©tect√©s`);
        recommendations.push('Supprimer ou changer les comptes de test/d√©mo');
      } else {
        securityScore += 20;
      }
    } catch (e) {
      issues.push('Impossible de v√©rifier les utilisateurs par d√©faut');
    }

    // 5. V√©rification des mots de passe
    try {
      const users = await prisma.user.findMany({
        where: { password: { not: null } },
        select: { email: true, password: true }
      });
      
      if (users.length > 0) {
        securityScore += 15; // Mots de passe hash√©s
      }
    } catch (e) {
      issues.push('Impossible de v√©rifier le hashage des mots de passe');
    }

    // 6. V√©rification des sessions et authentification 2FA
    try {
      const twoFactorEnabled = await prisma.user.count({
        where: { twoFactorEnabled: true }
      });
      
      if (twoFactorEnabled > 0) {
        securityScore += 15;
      } else {
        recommendations.push('Activer la 2FA pour les administrateurs');
      }
    } catch (e) {
      issues.push('Impossible de v√©rifier la 2FA');
    }

    this.results.security = { score: Math.min(securityScore, 100), issues, recommendations };
    console.log(`   Score s√©curit√©: ${this.results.security.score}/100`);
  }

  async auditDatabase() {
    console.log('\nüíæ AUDIT BASE DE DONN√âES...');
    
    let dbScore = 0;
    const issues = [];
    const recommendations = [];
    const stats = {};

    try {
      // 1. Statistiques g√©n√©rales
      stats.users = await prisma.user.count();
      stats.clients = await prisma.user.count({ where: { role: 'CLIENT' } });
      stats.commerciaux = await prisma.user.count({ where: { role: 'COMMERCIAL' } });
      stats.chantiers = await prisma.chantier.count();
      stats.devis = await prisma.devis.count({ where: { type: 'DEVIS' } });
      stats.factures = await prisma.devis.count({ where: { type: 'FACTURE' } });
      stats.interactions = await prisma.interactionClient.count();
      stats.opportunites = await prisma.opportunite.count();

      if (stats.users > 0) dbScore += 15;
      if (stats.chantiers > 0) dbScore += 15;
      if (stats.devis > 0) dbScore += 15;

      // 2. Int√©grit√© des relations
      const chantiersOrphans = await prisma.chantier.count({
        where: { client: null }
      });
      
      if (chantiersOrphans === 0) {
        dbScore += 15;
      } else {
        issues.push(`${chantiersOrphans} chantiers orphelins d√©tect√©s`);
        recommendations.push('Nettoyer les chantiers sans clients');
      }

      // 3. V√©rification des contraintes
      const devisWithoutClient = await prisma.devis.count({
        where: { client: null }
      });
      
      if (devisWithoutClient === 0) {
        dbScore += 15;
      } else {
        issues.push(`${devisWithoutClient} devis sans client`);
        recommendations.push('Nettoyer les devis orphelins');
      }

      // 4. Performance des requ√™tes (approximation)
      const start = Date.now();
      await prisma.user.findMany({
        take: 10,
        include: {
          chantiers: true,
          devis: true
        }
      });
      const queryTime = Date.now() - start;
      
      if (queryTime < 100) {
        dbScore += 15;
      } else if (queryTime < 500) {
        dbScore += 10;
        recommendations.push('Optimiser les index de la base de donn√©es');
      } else {
        issues.push('Requ√™tes lentes d√©tect√©es');
        recommendations.push('Optimiser les performances de la base de donn√©es');
      }

      // 5. Donn√©es de test/d√©mo
      const testData = await prisma.user.count({
        where: {
          OR: [
            { email: { contains: 'test' } },
            { email: { contains: 'demo' } },
            { name: { contains: 'TEST' } }
          ]
        }
      });
      
      if (testData === 0) {
        dbScore += 10;
      } else {
        issues.push(`${testData} entr√©es de test d√©tect√©es`);
        recommendations.push('Nettoyer les donn√©es de test avant la production');
      }

    } catch (error) {
      issues.push('Erreur lors de l\'analyse de la base de donn√©es');
      recommendations.push('V√©rifier la connectivit√© et les permissions de la base');
    }

    this.results.database = { score: Math.min(dbScore, 100), stats, issues, recommendations };
    console.log(`   Score base de donn√©es: ${this.results.database.score}/100`);
  }

  async auditFunctionality() {
    console.log('\n‚öôÔ∏è AUDIT FONCTIONNALIT√âS...');
    
    let funcScore = 0;
    const modules = [];
    const issues = [];
    const recommendations = [];

    // Test des modules principaux
    const modulesToTest = [
      { name: 'Gestion Clients', test: () => prisma.user.count({ where: { role: 'CLIENT' } }) },
      { name: 'Gestion Chantiers', test: () => prisma.chantier.count() },
      { name: 'Gestion Devis', test: () => prisma.devis.count({ where: { type: 'DEVIS' } }) },
      { name: 'Gestion Factures', test: () => prisma.devis.count({ where: { type: 'FACTURE' } }) },
      { name: 'CRM Interactions', test: () => prisma.interactionClient.count() },
      { name: 'CRM Opportunit√©s', test: () => prisma.opportunite.count() },
      { name: 'Planning √âtapes', test: () => prisma.etapeChantier.count() },
      { name: 'Biblioth√®que Prix', test: () => prisma.bibliothequePrix.count() },
      { name: 'Projets BTP', test: () => prisma.projet.count() }
    ];

    for (const module of modulesToTest) {
      try {
        const count = await module.test();
        const status = count > 0 ? 'Actif' : 'Vide';
        modules.push({
          name: module.name,
          status: status,
          count: count
        });
        
        if (count > 0) funcScore += 10;
      } catch (error) {
        modules.push({
          name: module.name,
          status: 'Erreur',
          error: error.message
        });
        issues.push(`Module ${module.name}: ${error.message}`);
      }
    }

    // V√©rification des relations complexes
    try {
      const relationTests = await Promise.all([
        prisma.user.findMany({
          where: { role: 'CLIENT' },
          include: { chantiers: true, devis: true },
          take: 1
        }),
        prisma.chantier.findMany({
          include: { client: true, etapes: true },
          take: 1
        }),
        prisma.devis.findMany({
          include: { client: true, chantier: true, ligneDevis: true },
          take: 1
        })
      ]);
      
      funcScore += 15; // Relations fonctionnelles
    } catch (error) {
      issues.push('Probl√®me avec les relations entre entit√©s');
      recommendations.push('V√©rifier l\'int√©grit√© des relations Prisma');
    }

    this.results.functionality = { score: Math.min(funcScore, 100), modules, issues, recommendations };
    console.log(`   Score fonctionnalit√©s: ${this.results.functionality.score}/100`);
  }

  async auditPerformance() {
    console.log('\nüöÄ AUDIT PERFORMANCE...');
    
    let perfScore = 0;
    const metrics = [];
    const issues = [];
    const recommendations = [];

    // 1. Temps de r√©ponse des requ√™tes critiques
    const performanceTests = [
      {
        name: 'Connexion base de donn√©es',
        test: async () => {
          const start = Date.now();
          await prisma.$queryRaw`SELECT 1`;
          return Date.now() - start;
        },
        threshold: 50
      },
      {
        name: 'Liste clients (pagin√©e)',
        test: async () => {
          const start = Date.now();
          await prisma.user.findMany({
            where: { role: 'CLIENT' },
            take: 20,
            orderBy: { createdAt: 'desc' }
          });
          return Date.now() - start;
        },
        threshold: 200
      },
      {
        name: 'Chantiers avec relations',
        test: async () => {
          const start = Date.now();
          await prisma.chantier.findMany({
            include: { client: true },
            take: 10
          });
          return Date.now() - start;
        },
        threshold: 300
      },
      {
        name: 'Devis avec lignes',
        test: async () => {
          const start = Date.now();
          await prisma.devis.findMany({
            include: { 
              ligneDevis: true,
              client: true 
            },
            take: 10
          });
          return Date.now() - start;
        },
        threshold: 400
      }
    ];

    for (const test of performanceTests) {
      try {
        const time = await test.test();
        metrics.push({
          name: test.name,
          time: time,
          status: time <= test.threshold ? 'Excellent' : time <= test.threshold * 2 ? 'Correct' : 'Lent'
        });
        
        if (time <= test.threshold) {
          perfScore += 20;
        } else if (time <= test.threshold * 2) {
          perfScore += 10;
          recommendations.push(`Optimiser ${test.name} (${time}ms > ${test.threshold}ms)`);
        } else {
          issues.push(`${test.name} trop lent: ${time}ms`);
          recommendations.push(`Optimiser urgemment ${test.name}`);
        }
      } catch (error) {
        metrics.push({
          name: test.name,
          time: -1,
          status: 'Erreur',
          error: error.message
        });
        issues.push(`Test ${test.name} √©chou√©: ${error.message}`);
      }
    }

    // 2. V√©rification des index de base
    try {
      // Simulation de test d'index sur les champs les plus utilis√©s
      const indexTests = [
        { table: 'User', field: 'email' },
        { table: 'User', field: 'role' },
        { table: 'Chantier', field: 'clientId' },
        { table: 'Devis', field: 'clientId' }
      ];
      
      perfScore += 20; // Assume que Prisma g√®re les index automatiquement
    } catch (error) {
      issues.push('Impossible de v√©rifier les index de performance');
    }

    this.results.performance = { score: Math.min(perfScore, 100), metrics, issues, recommendations };
    console.log(`   Score performance: ${this.results.performance.score}/100`);
  }

  async auditCodeQuality() {
    console.log('\nüìã AUDIT QUALIT√â DU CODE...');
    
    let codeScore = 0;
    const metrics = {};
    const issues = [];
    const recommendations = [];

    try {
      // 1. Structure des fichiers
      const appDir = 'app';
      const componentsDir = 'components';
      const libDir = 'lib';
      
      if (fs.existsSync(appDir)) {
        codeScore += 15;
        metrics.appStructure = 'Next.js App Router';
      }
      
      if (fs.existsSync(componentsDir)) {
        codeScore += 15;
        metrics.componentStructure = 'Composants s√©par√©s';
      }
      
      if (fs.existsSync(libDir)) {
        codeScore += 15;
        metrics.libStructure = 'Biblioth√®ques organis√©es';
      }

      // 2. Configuration TypeScript
      if (fs.existsSync('tsconfig.json')) {
        codeScore += 15;
        metrics.typescript = 'Activ√©';
      } else {
        issues.push('TypeScript non configur√©');
        recommendations.push('Migrer vers TypeScript pour une meilleure robustesse');
      }

      // 3. Configuration ESLint
      if (fs.existsSync('.eslintrc.json') || fs.existsSync('.eslintrc.js')) {
        codeScore += 10;
        metrics.linting = 'ESLint configur√©';
      } else {
        recommendations.push('Configurer ESLint pour la qualit√© du code');
      }

      // 4. Tests
      if (fs.existsSync('__tests__') || fs.existsSync('tests') || fs.existsSync('test')) {
        codeScore += 15;
        metrics.testing = 'Tests pr√©sents';
      } else {
        issues.push('Aucun test d√©tect√©');
        recommendations.push('Impl√©menter des tests unitaires et d\'int√©gration');
      }

      // 5. Documentation
      if (fs.existsSync('README.md')) {
        codeScore += 10;
        metrics.documentation = 'README pr√©sent';
      }

      // 6. Configuration Prisma
      if (fs.existsSync('prisma/schema.prisma')) {
        codeScore += 5;
        metrics.database = 'Prisma ORM';
      }

    } catch (error) {
      issues.push('Erreur lors de l\'analyse de la structure du code');
    }

    this.results.codeQuality = { score: Math.min(codeScore, 100), metrics, issues, recommendations };
    console.log(`   Score qualit√© du code: ${this.results.codeQuality.score}/100`);
  }

  async auditConfiguration() {
    console.log('\n‚öôÔ∏è AUDIT CONFIGURATION...');
    
    let configScore = 0;
    const config = {};
    const issues = [];
    const recommendations = [];

    // 1. Variables d'environnement
    const requiredEnvVars = [
      'DATABASE_URL',
      'NEXTAUTH_URL', 
      'NEXTAUTH_SECRET'
    ];

    const optionalEnvVars = [
      'REDIS_URL',
      'MAX_FILE_SIZE',
      'ALLOWED_FILE_TYPES',
      'LOG_LEVEL'
    ];

    let envScore = 0;
    requiredEnvVars.forEach(varName => {
      if (process.env[varName]) {
        envScore += 20;
        config[varName] = '‚úì Configur√©';
      } else {
        issues.push(`Variable requise manquante: ${varName}`);
        config[varName] = '‚úó Manquant';
      }
    });

    optionalEnvVars.forEach(varName => {
      if (process.env[varName]) {
        envScore += 5;
        config[varName] = '‚úì Configur√©';
      } else {
        config[varName] = '- Optionnel';
      }
    });

    configScore += Math.min(envScore, 80);

    // 2. Configuration de s√©curit√©
    if (process.env.NODE_ENV === 'production') {
      configScore += 10;
      config.environment = 'Production';
      
      if (!process.env.NEXTAUTH_URL?.startsWith('https://')) {
        issues.push('HTTPS requis en production');
        recommendations.push('Configurer HTTPS pour la production');
      }
    } else {
      config.environment = 'D√©veloppement';
      configScore += 5;
    }

    // 3. Configuration Prisma
    if (fs.existsSync('prisma/schema.prisma')) {
      configScore += 10;
      config.database = '‚úì Schema Prisma';
    }

    this.results.configuration = { score: Math.min(configScore, 100), config, issues, recommendations };
    console.log(`   Score configuration: ${this.results.configuration.score}/100`);
  }

  calculateOverallScore() {
    const scores = [
      this.results.security.score,
      this.results.database.score,
      this.results.functionality.score,
      this.results.performance.score,
      this.results.codeQuality.score,
      this.results.configuration.score
    ];

    // Pond√©ration: s√©curit√© et fonctionnalit√© plus importantes
    this.results.overallScore = Math.round(
      (this.results.security.score * 0.25) +
      (this.results.functionality.score * 0.25) +
      (this.results.database.score * 0.20) +
      (this.results.performance.score * 0.15) +
      (this.results.codeQuality.score * 0.10) +
      (this.results.configuration.score * 0.05)
    );
  }

  async generateReport() {
    console.log('\nüìä G√âN√âRATION DU RAPPORT...');
    
    const report = `
# RAPPORT D'AUDIT COMPLET - CHANTIERPRO CRM BTP

**Date:** ${new Date().toLocaleString('fr-FR')}
**Version:** ChantierPro CRM Application

## üìä SCORE G√âN√âRAL: ${this.results.overallScore}/100

${this.results.overallScore >= 90 ? 'üü¢ EXCELLENT' :
  this.results.overallScore >= 75 ? 'üü° BON' :
  this.results.overallScore >= 60 ? 'üü† CORRECT' : 'üî¥ √Ä AM√âLIORER'}

---

## üîí S√âCURIT√â: ${this.results.security.score}/100

### Issues identifi√©es:
${this.results.security.issues.map(issue => `- ‚ùå ${issue}`).join('\n') || '- ‚úÖ Aucune issue majeure'}

### Recommandations:
${this.results.security.recommendations.map(rec => `- üí° ${rec}`).join('\n') || '- ‚úÖ Configuration s√©curis√©e'}

---

## üíæ BASE DE DONN√âES: ${this.results.database.score}/100

### Statistiques:
- **Utilisateurs totaux:** ${this.results.database.stats.users || 0}
- **Clients:** ${this.results.database.stats.clients || 0}
- **Commerciaux:** ${this.results.database.stats.commerciaux || 0}
- **Chantiers:** ${this.results.database.stats.chantiers || 0}
- **Devis:** ${this.results.database.stats.devis || 0}
- **Factures:** ${this.results.database.stats.factures || 0}
- **Interactions CRM:** ${this.results.database.stats.interactions || 0}
- **Opportunit√©s:** ${this.results.database.stats.opportunites || 0}

### Issues identifi√©es:
${this.results.database.issues.map(issue => `- ‚ùå ${issue}`).join('\n') || '- ‚úÖ Base de donn√©es saine'}

### Recommandations:
${this.results.database.recommendations.map(rec => `- üí° ${rec}`).join('\n') || '- ‚úÖ Optimisation correcte'}

---

## ‚öôÔ∏è FONCTIONNALIT√âS: ${this.results.functionality.score}/100

### Modules test√©s:
${this.results.functionality.modules.map(module => 
  `- **${module.name}:** ${module.status} ${module.count !== undefined ? `(${module.count} entr√©es)` : ''}`
).join('\n')}

### Issues identifi√©es:
${this.results.functionality.issues.map(issue => `- ‚ùå ${issue}`).join('\n') || '- ‚úÖ Tous les modules fonctionnels'}

---

## üöÄ PERFORMANCE: ${this.results.performance.score}/100

### M√©triques:
${this.results.performance.metrics.map(metric => 
  `- **${metric.name}:** ${metric.time}ms (${metric.status})`
).join('\n')}

### Issues de performance:
${this.results.performance.issues.map(issue => `- ‚ö†Ô∏è ${issue}`).join('\n') || '- ‚úÖ Performances acceptables'}

### Recommandations:
${this.results.performance.recommendations.map(rec => `- üí° ${rec}`).join('\n') || '- ‚úÖ Performance optimale'}

---

## üìã QUALIT√â DU CODE: ${this.results.codeQuality.score}/100

### M√©triques:
${Object.entries(this.results.codeQuality.metrics).map(([key, value]) => 
  `- **${key}:** ${value}`
).join('\n')}

### Issues identifi√©es:
${this.results.codeQuality.issues.map(issue => `- ‚ùå ${issue}`).join('\n') || '- ‚úÖ Code bien structur√©'}

### Recommandations:
${this.results.codeQuality.recommendations.map(rec => `- üí° ${rec}`).join('\n') || '- ‚úÖ Qualit√© satisfaisante'}

---

## ‚öôÔ∏è CONFIGURATION: ${this.results.configuration.score}/100

### Configuration syst√®me:
${Object.entries(this.results.configuration.config).map(([key, value]) => 
  `- **${key}:** ${value}`
).join('\n')}

### Issues de configuration:
${this.results.configuration.issues.map(issue => `- ‚ùå ${issue}`).join('\n') || '- ‚úÖ Configuration compl√®te'}

---

## üéØ PLAN D'ACTION PRIORITAIRE

### Actions CRITIQUES (√† faire imm√©diatement):
${[
  ...this.results.security.issues.filter(i => i.includes('par d√©faut') || i.includes('faible')),
  ...this.results.database.issues.filter(i => i.includes('orphelin')),
  ...this.results.functionality.issues.filter(i => i.includes('Erreur'))
].map(action => `- üî¥ ${action}`).join('\n') || '- ‚úÖ Aucune action critique'}

### Actions IMPORTANTES (dans les 7 jours):
${[
  ...this.results.performance.issues,
  ...this.results.codeQuality.issues.filter(i => i.includes('test'))
].map(action => `- üü° ${action}`).join('\n') || '- ‚úÖ Aucune action urgente'}

### Am√©liorations RECOMMAND√âES (√† planifier):
${[
  ...this.results.security.recommendations.slice(0, 3),
  ...this.results.performance.recommendations.slice(0, 2),
  ...this.results.codeQuality.recommendations.slice(0, 2)
].map(action => `- üü¢ ${action}`).join('\n')}

---

## ‚úÖ CONCLUSION

${
this.results.overallScore >= 85 ? 
  'üéâ **F√âLICITATIONS!** Votre application ChantierPro est de tr√®s bonne qualit√©. Les modules fonctionnent correctement et la s√©curit√© est bien g√©r√©e.' :
this.results.overallScore >= 70 ?
  'üëç **BON TRAVAIL!** L\'application ChantierPro fonctionne bien. Quelques am√©liorations mineures sont recommand√©es.' :
this.results.overallScore >= 55 ?
  '‚ö†Ô∏è **ATTENTION!** L\'application fonctionne mais n√©cessite des am√©liorations importantes, notamment en s√©curit√© et performance.' :
  'üö® **ACTION REQUISE!** L\'application pr√©sente des probl√®mes critiques qui doivent √™tre r√©solus avant la mise en production.'
}

**Score global: ${this.results.overallScore}/100**

---

*Rapport g√©n√©r√© automatiquement par l'outil d'audit ChantierPro*
*Pour toute question, consultez la documentation technique*
`;

    // Sauvegarder le rapport
    const reportPath = path.join(process.cwd(), 'AUDIT_RAPPORT_COMPLET.md');
    fs.writeFileSync(reportPath, report, 'utf8');
    
    console.log(`\n‚úÖ Rapport sauvegard√©: ${reportPath}`);
    console.log(`\nüéØ SCORE FINAL: ${this.results.overallScore}/100`);
    
    // Affichage console du r√©sum√©
    console.log('\n' + '='.repeat(60));
    console.log('üìä R√âSUM√â EX√âCUTIF');
    console.log('='.repeat(60));
    console.log(`üîí S√©curit√©:        ${this.results.security.score}/100`);
    console.log(`üíæ Base de donn√©es: ${this.results.database.score}/100`);
    console.log(`‚öôÔ∏è  Fonctionnalit√©s: ${this.results.functionality.score}/100`);
    console.log(`üöÄ Performance:     ${this.results.performance.score}/100`);
    console.log(`üìã Qualit√© code:    ${this.results.codeQuality.score}/100`);
    console.log(`‚öôÔ∏è  Configuration:   ${this.results.configuration.score}/100`);
    console.log('='.repeat(60));
    console.log(`üéØ SCORE GLOBAL:    ${this.results.overallScore}/100`);
    console.log('='.repeat(60));
  }
}

// Ex√©cution de l'audit
async function runAudit() {
  const audit = new ChantierProAudit();
  
  try {
    await audit.runFullAudit();
    console.log('\n‚úÖ AUDIT TERMIN√â AVEC SUCC√àS!');
    console.log('üìÑ Consultez le fichier AUDIT_RAPPORT_COMPLET.md pour les d√©tails');
    process.exit(0);
  } catch (error) {
    console.error('\n‚ùå √âCHEC DE L\'AUDIT:', error.message);
    process.exit(1);
  } finally {
    await prisma.$disconnect();
  }
}

// D√©marrer l'audit si le script est ex√©cut√© directement
if (require.main === module) {
  runAudit();
}

module.exports = { ChantierProAudit };